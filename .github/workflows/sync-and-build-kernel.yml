# Sync ChromeOS kernel and build/publish okLinux kernel
#
# Required secrets:
#   KERNEL_REPO_TOKEN - A GitHub Personal Access Token (PAT) with push access
#                       to sevki/kernel. Create a fine-grained PAT at
#                       https://github.com/settings/tokens with "Contents: Read
#                       and write" permission scoped to sevki/kernel, then add
#                       it as a repository secret in sevki/okLinux settings.

name: Sync & Build Kernel

on:
  schedule:
    - cron: "0 0 * * *" # daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: kernel-sync
  cancel-in-progress: false

jobs:
  # ── Job 1: mirror upstream → sevki/kernel ──────────────────────────
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Clone upstream ChromeOS kernel
        run: |
          git clone --bare --single-branch --branch chromeos-6.6 \
            https://chromium.googlesource.com/chromiumos/third_party/kernel \
            kernel.git

      - name: Push to sevki/kernel
        run: |
          cd kernel.git
          git remote add target \
            https://x-access-token:${{ secrets.KERNEL_REPO_TOKEN }}@github.com/sevki/kernel.git
          git push target "refs/heads/chromeos-6.6:refs/heads/chromeos-6.6" --force

  # ── Job 2: build & publish ─────────────────────────────────────────
  build:
    needs: sync
    runs-on: ubuntu-latest
    outputs:
      kernel_release: ${{ steps.meta.outputs.kernel_release }}
      commit_sha: ${{ steps.meta.outputs.commit_sha }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
      tarball_name: ${{ steps.meta.outputs.tarball_name }}
    steps:
      - name: Checkout kernel source
        run: |
          git clone --depth 1 --branch chromeos-6.6 \
            https://github.com/sevki/kernel.git kernel

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc kmod cpio flex libncurses5-dev \
            libelf-dev libssl-dev dwarves bison

      - name: Build kernel
        working-directory: kernel
        run: |
          if make chromeos_defconfig 2>/dev/null; then
            echo "Using chromeos_defconfig"
          else
            echo "chromeos_defconfig not found, falling back to x86_64_defconfig"
            make x86_64_defconfig
          fi
          make -j"$(nproc)"

      - name: Collect metadata
        id: meta
        working-directory: kernel
        run: |
          KERNEL_RELEASE=$(make -s kernelrelease)
          COMMIT_SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TARBALL="oklinux-kernel-x86_64-${KERNEL_RELEASE}-${COMMIT_SHA}.tar.gz"
          echo "kernel_release=${KERNEL_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${COMMIT_SHA}"         >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}"            >> "$GITHUB_OUTPUT"
          echo "tarball_name=${TARBALL}"            >> "$GITHUB_OUTPUT"

      - name: Package kernel
        run: |
          TARBALL="${{ steps.meta.outputs.tarball_name }}"
          tar czf "${TARBALL}" -C kernel arch/x86/boot/bzImage
          sha256sum "${TARBALL}" | tee "${TARBALL}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            oklinux-kernel-*.tar.gz
            oklinux-kernel-*.tar.gz.sha256

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="kernel-${{ steps.meta.outputs.kernel_release }}-$(date +%Y%m%d)-${{ steps.meta.outputs.short_sha }}"
          TARBALL="${{ steps.meta.outputs.tarball_name }}"

          gh release create "${TAG}" \
            --repo "${{ github.repository }}" \
            --title "Kernel ${TAG}" \
            --notes "Automated kernel build from chromeos-6.6 branch.

          - Kernel release: \`${{ steps.meta.outputs.kernel_release }}\`
          - Upstream commit: \`${{ steps.meta.outputs.commit_sha }}\`" \
            "${TARBALL}" "${TARBALL}.sha256"

  # ── Job 3: update okLinux repo & website ───────────────────────────
  update-website:
    needs: build
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: "0.4.36"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Update kernel-version.txt
        run: |
          echo "${{ needs.build.outputs.kernel_release }}" > kernel-version.txt

      - name: Commit version bump
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add kernel-version.txt
            git commit -m "chore: bump kernel version to ${{ needs.build.outputs.kernel_release }}"
            git push
          fi

      - name: Install mdBook
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . "$HOME/.cargo/env"
          cargo install --version ${MDBOOK_VERSION} mdbook

      - name: Build website
        run: mdbook build

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./book

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
