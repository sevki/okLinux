# Build the ChromeOS kernel and publish a release, then update the website

name: Build Kernel

on:
  schedule:
    - cron: "0 0 * * *" # daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      kernel_release: ${{ steps.meta.outputs.kernel_release }}
      commit_sha: ${{ steps.meta.outputs.commit_sha }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
      tarball_name: ${{ steps.meta.outputs.tarball_name }}
    env:
      MDBOOK_VERSION: "0.4.36"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Clone upstream kernel source
        run: |
          git clone --depth 1 -b chromeos-6.6 \
            https://chromium.googlesource.com/chromiumos/third_party/kernel \
            kernel

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc kmod cpio flex libncurses5-dev \
            libelf-dev libssl-dev dwarves bison

      - name: Configure kernel
        working-directory: kernel
        run: |
          CHROMEOS_KERNEL_FAMILY=termina ./chromeos/scripts/prepareconfig container-vm-x86_64
          make olddefconfig

      - name: Build bzImage
        working-directory: kernel
        run: make -j"$(nproc)" bzImage

      - name: Collect metadata
        id: meta
        working-directory: kernel
        run: |
          KERNEL_RELEASE=$(make -s kernelrelease)
          COMMIT_SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TARBALL="oklinux-kernel-x86_64-${KERNEL_RELEASE}-${COMMIT_SHA}.tar.gz"
          echo "kernel_release=${KERNEL_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${COMMIT_SHA}"         >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}"            >> "$GITHUB_OUTPUT"
          echo "tarball_name=${TARBALL}"            >> "$GITHUB_OUTPUT"

      - name: Package kernel
        run: |
          TARBALL="${{ steps.meta.outputs.tarball_name }}"
          tar czf "${TARBALL}" -C kernel arch/x86/boot/bzImage
          sha256sum "${TARBALL}" | tee "${TARBALL}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            oklinux-kernel-*.tar.gz
            oklinux-kernel-*.tar.gz.sha256

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="kernel-${{ steps.meta.outputs.kernel_release }}-$(date +%Y%m%d)-${{ steps.meta.outputs.short_sha }}"
          TARBALL="${{ steps.meta.outputs.tarball_name }}"

          gh release create "${TAG}" \
            --repo "${{ github.repository }}" \
            --title "Kernel ${TAG}" \
            --notes "Automated kernel build from chromeos-6.6 branch.

          - Kernel release: \`${{ steps.meta.outputs.kernel_release }}\`
          - Upstream commit: \`${{ steps.meta.outputs.commit_sha }}\`" \
            "${TARBALL}" "${TARBALL}.sha256"

      - name: Update kernel-version.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="kernel-${{ steps.meta.outputs.kernel_release }}-$(date +%Y%m%d)-${{ steps.meta.outputs.short_sha }}"
          VERSION=$(echo "${TAG}" | sed 's/^kernel-//;s/-[0-9]\{8\}-.*$//')
          echo "${VERSION}" > kernel-version.txt

      - name: Commit version bump
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet kernel-version.txt 2>/dev/null; then
            git add kernel-version.txt
            git commit -m "chore: bump kernel version"
            git push
          fi
